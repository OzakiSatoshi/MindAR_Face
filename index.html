<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-aframe.prod.js"></script>
    <style>
      .error-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 1001;
        display: none;
      }

      .error-container button {
        margin-top: 10px;
        padding: 5px 10px;
        background: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- エラー表示 -->
    <div class="error-container" id="errorContainer">
      <div id="errorMessage"></div>
      <button id="retryButton">再試行</button>
    </div>

    <!-- ARシーン -->
    <a-scene mindar-face embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights, useLegacyLights: false" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;" id="ar-scene">
      <a-assets>
        <a-asset-item id="glassesModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/face-tracking/assets/glasses/scene.gltf"></a-asset-item>
      </a-assets>

      <a-camera active="false" position="0 0 0"></a-camera>

      <a-entity mindar-face-target="anchorIndex: 168">
        <a-gltf-model rotation="0 0 0" position="0 0 0" scale="0.01 0.01 0.01" src="#glassesModel"></a-gltf-model>
      </a-entity>
    </a-scene>

    <!-- キャプチャ用ボタン -->
    <button id="capture-btn" disabled>撮影</button>

    <canvas id="arCanvas" style="display:none;"></canvas>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const retryButton = document.getElementById('retryButton');
        const scene = document.querySelector('a-scene');
        const captureBtn = document.getElementById('capture-btn');

        // エラー表示
        const showError = (message, isRetryable = true) => {
          errorMessage.textContent = message;
          retryButton.style.display = isRetryable ? 'block' : 'none';
          errorContainer.style.display = 'block';
        };

        // カメラアクセス確認
        const checkCameraAccess = async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(track => track.stop());
            return true;
          } catch (error) {
            showError('カメラへのアクセスが拒否されました。ブラウザの設定を確認してください。', false);
            throw new Error('カメラアクセスエラー: ' + error.message);
          }
        };

        // モデルロード確認
        const checkModelLoading = async () => {
          const model = document.querySelector('a-gltf-model');
          return new Promise((resolve, reject) => {
            model.addEventListener('model-loaded', () => resolve(true));
            model.addEventListener('model-error', () => reject(false));
          });
        };

        // リトライ処理
        retryButton.addEventListener('click', async () => {
          errorContainer.style.display = 'none';
          await initARScene();
        });

        // 初期化
        const initARScene = async () => {
          try {
            await checkCameraAccess();
            await checkModelLoading();
            captureBtn.disabled = false;  // カメラアクセスとモデルのロードが成功したらボタンを有効化
          } catch (error) {
            showError(error.message);
            captureBtn.disabled = true;
          }
        };

        initARScene();
      });
    </script>
  </body>
</html>
